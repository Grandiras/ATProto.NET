@using Microsoft.AspNetCore.Components

<div class="atproto-login-form @CssClass">
    @if (!string.IsNullOrEmpty(_error))
    {
        <div class="atproto-login-error alert alert-danger" role="alert">
            @_error
        </div>
    }

    <form action="@LoginEndpoint" method="get">
        @* Handle / identifier *@
        <div class="atproto-login-field mb-3">
            <label for="atproto-handle" class="form-label">@HandleLabel</label>
            <input id="atproto-handle"
                   name="handle"
                   type="text"
                   class="form-control"
                   placeholder="@HandlePlaceholder"
                   required />
            <small class="atproto-login-hint form-text text-muted">@HandleHint</small>
        </div>

        @* Optional PDS URL — shown when user wants to specify their PDS directly *@
        @if (ShowPdsOption)
        {
            <div class="atproto-login-field mb-3">
                <div class="form-check mb-2">
                    <input id="atproto-specify-pds"
                           type="checkbox"
                           class="form-check-input"
                           @bind="_specifyPds" />
                    <label for="atproto-specify-pds" class="form-check-label text-muted">
                        @PdsCheckboxLabel
                    </label>
                </div>
                @if (_specifyPds)
                {
                    <input id="atproto-pds-url"
                           name="pdsUrl"
                           type="url"
                           class="form-control"
                           placeholder="https://pds.example.com" />
                    <small class="form-text text-muted">@PdsHint</small>
                }
            </div>
        }

        <input type="hidden" name="returnUrl" value="@ReturnUrl" />

        <button type="submit" class="atproto-login-button btn btn-primary w-100">
            @ButtonText
        </button>
    </form>
</div>

@code {
    [Inject] private NavigationManager Navigation { get; set; } = default!;

    /// <summary>
    /// The login endpoint URL that the form submits to.
    /// Default: "/atproto/login" (matches <c>MapAtProtoOAuth()</c> defaults).
    /// </summary>
    [Parameter] public string LoginEndpoint { get; set; } = "/atproto/login";

    /// <summary>
    /// URL to redirect to after successful login.
    /// Default: "/".
    /// </summary>
    [Parameter] public string ReturnUrl { get; set; } = "/";

    /// <summary>Optional CSS class for the form container.</summary>
    [Parameter] public string? CssClass { get; set; }

    /// <summary>
    /// Whether to show the "Specify PDS manually" option.
    /// Default: true.
    /// </summary>
    [Parameter] public bool ShowPdsOption { get; set; } = true;

    /// <summary>Label for the handle input field. Default: "Handle".</summary>
    [Parameter] public string HandleLabel { get; set; } = "Handle";

    /// <summary>Placeholder for the handle input field. Default: "alice.bsky.social".</summary>
    [Parameter] public string HandlePlaceholder { get; set; } = "alice.bsky.social";

    /// <summary>Hint text below the handle input. Default: "Your AT Protocol handle — PDS is detected automatically.".</summary>
    [Parameter] public string HandleHint { get; set; } = "Your AT Protocol handle — PDS is detected automatically.";

    /// <summary>Label for the PDS checkbox. Default: "Specify PDS manually".</summary>
    [Parameter] public string PdsCheckboxLabel { get; set; } = "Specify PDS manually";

    /// <summary>Hint text below the PDS URL input. Default: "Skip automatic PDS discovery and connect directly.".</summary>
    [Parameter] public string PdsHint { get; set; } = "Skip automatic PDS discovery and connect directly.";

    /// <summary>Text for the submit button. Default: "Sign in with AT Proto".</summary>
    [Parameter] public string ButtonText { get; set; } = "Sign in with AT Proto";

    private bool _specifyPds;
    private string? _error;

    protected override void OnInitialized()
    {
        // Show error from OAuth callback redirect (passed as ?error= query parameter)
        var uri = new Uri(Navigation.Uri);
        var queryParams = System.Web.HttpUtility.ParseQueryString(uri.Query);
        _error = queryParams["error"];
    }
}
